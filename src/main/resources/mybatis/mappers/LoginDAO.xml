<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.LoginDAO">

    <!-- 로그인 여부 확인 -->
    <select id="loginYn" resultType="com.boot.dto.LoginDTO">
    	select member_pw AS memberPw,
        member_id AS memberId,
        member_name AS memberName
        from user_db
        where member_id=#{memberId}
        and member_status = 'ACTIVE'
    </select>
        
    <!-- 회원 가입 -->
    <insert id="write">
        insert into user_db
            (member_id,
            member_pw,
            member_name,
            member_email,
            member_phone,
            member_zipcode,
            member_addr1, member_addr2,
            social_login,
            member_point
        )
        values(
            #{memberId},
            #{memberPw, jdbcType=VARCHAR},
            #{memberName},#{memberEmail},
            #{memberPhone, jdbcType=VARCHAR},
            #{memberZipcode},
            #{memberAddr1},#{memberAddr2},
            #{socialLogin},
            0
        )
    </insert>
    
    <!-- 아이디 중복 확인 (ID: idCheck) -->
    <select id="idCheck" resultType="com.boot.dto.LoginDTO">
    	select member_id AS memberId from user_db where member_id=#{memberId}
    </select>
    
    <!-- 이메일 중복 확인 (ID: emailCheck) -->
    <select id="emailCheck" resultType="com.boot.dto.LoginDTO">
    	select member_email AS memberEmail from user_db where member_email=#{memberEmail}
    </select>
    
    <!-- 아이디 찾기 (추가: 이름과 이메일로 검색) -->
    <select id="findId" resultType="com.boot.dto.LoginDTO">
        select member_id AS memberId, member_email AS memberEmail from user_db 
        where member_name = #{memberName} and member_email = #{memberEmail}
    </select>
    
    <!-- 비밀번호 찾기 (추가: 아이디, 이름, 이메일로 검색) -->
    <select id="findPw" resultType="com.boot.dto.LoginDTO">
        select member_id AS memberId, member_name AS memberName, member_pw AS memberPw, member_email AS memberEmail from user_db 
        where member_id = #{memberId} and member_name = #{memberName} and member_email = #{memberEmail}
    </select>
    
    <!-- 비밀번호 업데이트 (임시 비밀번호 발급 시 사용) -->
    <update id="updatePw">
        update user_db set member_pw = #{memberPw} where member_id = #{memberId}
    </update>

    <!--   kakao용 이메일 확인-->
    <select id="findByEmail" resultType="com.boot.dto.LoginDTO">
        SELECT *
        FROM user_db
        WHERE member_email = #{email}

    </select>
    <!-- 삭제 계정 찾기  -->
    <select id="findDeletedByEmail" resultType="com.boot.dto.LoginDTO">
        SELECT *
        FROM user_db
        WHERE member_email = #{email}
        AND member_status = 'DELETED'
    </select>


    <!--   회원 탈퇴기능 DELETED로 수정 -->

    <update id="deleteUser" parameterType="string">
        UPDATE USER_DB
        SET MEMBER_STATUS = 'DELETED',
        MEMBER_ID = MEMBER_ID || '_deleted_' || TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),
        MEMBER_EMAIL = MEMBER_ID || '_deleted_' || TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),
        MEMBER_PW = 'deleted_' || DBMS_RANDOM.STRING('x', 20),
        MEMBER_PHONE = '000-0000-0000',
        MEMBER_ZIPCODE = '00000',
        MEMBER_ADDR1 = 'DELETED',
        MEMBER_ADDR2 = 'DELETED'
        WHERE MEMBER_ID = #{memberId}
    </update>

    <!--    카카오 회원탈퇴-->
    <update id="deleteKakaoUser" parameterType="string">
        UPDATE USER_DB
        SET MEMBER_STATUS = 'DELETED'
        WHERE MEMBER_ID = #{memberId}
    </update>
    <!-- 카카오 회원 재가입 시 STATUS를 ACTIVE 활성화.   -->

    <update id="reactivateUser" parameterType="string">
        UPDATE USER_DB
        SET MEMBER_STATUS = 'ACTIVE'
        WHERE MEMBER_EMAIL = #{value}
    </update>

    <!-- 포인트 기능 추가 -->
    <select id="getMemberPoint" resultType="int">
        SELECT MEMBER_POINT FROM USER_DB WHERE MEMBER_ID = #{memberId}
    </select>

    <update id="updateMemberPoint">
        UPDATE USER_DB SET MEMBER_POINT = #{point} WHERE MEMBER_ID = #{memberId}
    </update>

    <!-- 자동 로그인 기능 관련 SQL 제거 -->
    <!--
    <update id="insertRememberMeToken">
        UPDATE USER_DB SET REMEMBER_ME_TOKEN = #{token}, TOKEN_EXPIRY_DATE = #{expiryDate} WHERE MEMBER_ID = #{memberId}
    </update>

    <select id="findMemberByRememberMeToken" resultType="com.boot.dto.LoginDTO">
        SELECT MEMBER_ID, MEMBER_PW, MEMBER_NAME, MEMBER_EMAIL, MEMBER_PHONE, MEMBER_ZIPCODE, MEMBER_ADDR1, MEMBER_ADDR2, SOCIAL_LOGIN, REMEMBER_ME_TOKEN, TOKEN_EXPIRY_DATE
        FROM USER_DB
        WHERE REMEMBER_ME_TOKEN = #{token} AND TOKEN_EXPIRY_DATE > SYSDATE
    </select>

    <update id="deleteRememberMeToken">
        UPDATE USER_DB SET REMEMBER_ME_TOKEN = NULL, TOKEN_EXPIRY_DATE = NULL WHERE MEMBER_ID = #{memberId}
    </update>
    -->

</mapper>
