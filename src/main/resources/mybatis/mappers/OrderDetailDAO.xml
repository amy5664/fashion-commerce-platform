<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.OrderDetailDAO">

    <!-- 주문 상세 정보 저장 -->
    <insert id="save" parameterType="com.boot.dto.OrderDetailDTO">
        INSERT INTO ORDER_DETAILS (ORDERDETAILID, ORDERID, PRODUCTID, QUANTITY, PRICE)
        VALUES (ORDER_DETAIL_SEQ.NEXTVAL, #{orderId}, #{productId}, #{quantity}, #{price})
    </insert>

    <!-- 주문 ID로 주문 상세 목록 조회 -->
    <select id="findByOrderId" resultType="com.boot.dto.OrderDetailDTO">
        SELECT
            od.ORDERDETAILID as orderDetailId,
            od.ORDERID as orderId,
            od.PRODUCTID as productId,
            od.QUANTITY as quantity,
            od.PRICE as price,
            p.PROD_NAME as prodName,
            img.IMG_PATH as prodImage
        FROM ORDER_DETAILS od
        JOIN PRODUCT_DB p ON od.PRODUCTID = p.PROD_ID
        LEFT JOIN IMAGE_DB img ON p.PROD_ID = img.IMG_PROD_ID AND img.IS_MAIN = 'Y'
        WHERE od.ORDERID = #{orderId}
    </select>

    <!-- 특정 사용자가 특정 상품을 '구매확정' 했는지 확인 (리뷰 작성 자격) -->
    <select id="countConfirmedPurchase" resultType="int">
        SELECT COUNT(*)
        FROM ORDER_DETAILS od
        JOIN ORDER_DB o ON od.ORDERID = o.ORD_ID
        WHERE o.ORD_MEMID = #{memberId}
          AND od.PRODUCTID = #{productId}
          AND o.ORD_STATUS = '구매확정'
    </select>

    <select id="selectOrderDetailByOrderId" resultType="com.boot.dto.OrderDetailDTO">
        SELECT
            ORDERDETAILID AS orderDetailId,
            ORDERID AS orderId,
            PRODUCTID AS productId,
            QUANTITY AS quantity,
            PRICE AS price
        FROM ORDER_DETAILS
        WHERE ORDERID = #{orderId}
    </select>

</mapper>
